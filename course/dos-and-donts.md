[← Оглавление](../README.md)

# DOs and DON'Ts

Чек-лист правил работы с ИИ-инструментами. Собрано из всех модулей курса.

---
##1. Промптинг

**DO:**
- Структурируй: роль -> контекст -> задача -> критерии приёмки
- Указывай контекст: стек, версии, файлы, паттерны, ограничения
- Показывай ГДЕ и ЧТО, а не КАК
- Используй few-shot примеры (2-4) для специфичных паттернов
- Prompt chaining: анализ -> план -> реализация -> тесты
- Одна задача = один промпт = один результат
- Self-consistency: проверяй результат другой моделью
- Constraint prompting: ограничения формата и стиля кода

**DON'T:**
- Нечёткие формулировки ("сделай красивее", "оптимизируй")
- God-prompt — всё в одном запросе
- Промпт без контекста
- Смешанная ответственность ("добавь endpoint и заодно отрефактори модуль")
- Надеяться, что смена модели компенсирует плохой промпт

---
##2. Инструменты

**DO:**
- Комбинируй модели по ролям: Opus для архитектуры, Sonnet для реализации, DeepSeek/Haiku для рутины — экономия 50-80%
- Задача определяет инструмент: чат для обучения, copilot для автокомплита, CLI-агент для фич целиком
- Бесплатный стек покрывает 90% задач: OpenCode + DeepSeek API + Ollama ($5-10/мес)
- Ollama для приватных/NDA задач — данные не покидают машину
- Держи резервного провайдера

**DON'T:**
- Opus/GPT-5 для boilerplate — Ferrari для поездки в магазин
- Один инструмент и один провайдер на всё
- Игнорировать рост расходов — мониторь стоимость токенов
- Дорогая модель для массовых задач — DeepSeek в 10-30 раз дешевле

---
##3. Работа с агентами

**DO:**
- Разделяй Plan и Act — проверяй план до реализации
- TDD: сначала тесты, потом реализация, агент итерирует до зелёных
- Ralph Loop: Do -> Check (тесты/линтер/билд) -> Fix -> повтор
- AGENTS.md с 7 секциями: Project, Stack, Structure, Conventions, Rules, Forbidden, Before Starting Work
- Обновляй AGENTS.md после каждого нового типа ошибки агента
- Правило 3 итераций: если проблема не решена за 3 попытки — меняй подход
- Steering для сложных задач: research -> plan -> implement -> verify

**DON'T:**
- Доверять архитектурные решения без твоего согласия
- Крупная задача целиком — декомпозируй
- Пропускать code review "потому что тесты прошли"
- Писать в AGENTS.md то, что проверяется линтером

---
##4. Режимы: HITL vs Agentic

**DO:**

| Agentic (безопасно) | HITL (обязательно) |
|---------------------|--------------------|
| Unit-тесты | `git push` в main |
| Рефакторинг метода | Удаление файлов |
| CRUD endpoint | Изменение production БД |
| Генерация документации | Деплой в production |
| Рутинные задачи по шаблону | Бизнес-критичный код (платежи, PII) |

Правило: можно откатить `git reset` → Agentic. Нужна помощь других для отката → HITL.

**DON'T:**
- YOLO в production, с приватными данными или денежными операциями
- Отключать подтверждения на деструктивные операции

---
##5. Управление контекстом

**DO:**
- Спецификация перед реализацией — 15 мин спеки экономят часы переделок
- Иерархия: Constitution (~400 строк) -> Plans -> Traces -> Fails
- Traces заполняются инкрементально — сразу после каждого решения
- "MANDATORY" для обязательных действий — "Optional" = "не сделает"
- Machine-checkable checkpoints: "Create -> ID, Get -> object, Delete -> 404"
- Reflect-mode: отдельный агент для консолидации traces в конституцию
- После 5-10 traces — консолидируй в AGENTS.md
- Версионируй всё в git, изменения конституции через PR

**DON'T:**
- "Сделай как-нибудь" без спецификации
- 4000 строк воды вместо 400 строк полезного контекста
- Забывать trace-файлы — знания теряются между сессиями
- Агенты не пишут в конституцию напрямую — только через "For Constitution" в trace
- Устаревшая документация хуже отсутствия

---
##6. MCP

**DO:**
- Принцип наименьших привилегий: Git read-only, БД SELECT only
- Токены в переменных окружения: `"TOKEN": "${TOKEN}"`
- Whitelist вместо blacklist: "разрешено только git, npm, pytest"
- Ограничивай сетевой доступ MCP-серверов
- Node.js >= 18 для MCP-серверов

**DON'T:**
- MCP к production БД без read-only ограничений
- 10+ серверов одновременно — контекст перегружается
- DELETE/UPDATE права без явной необходимости
- Хардкод токенов в `mcp.json` — утечка при попадании в Git

---
##7. Параллельные агенты и оркестрация

**DO:**
- git worktree для каждого параллельного агента
- Один branch = один plan = один worktree
- Разные модели для разных ролей: Opus для архитектуры, Sonnet для планирования, Haiku для кодинга
- Playbook: каждый пункт — действие с критерием завершения
- Конфликты: arbiter-agent для простых, manual review для сложных
- Мониторинг: время, итерации, стоимость токенов

**DON'T:**
- Параллельные агенты без изоляции
- Оркестрация на legacy-коде без тестов и документации
- Оркестрация без CI

---
##8. Безопасность и конфиденциальность

**Defence in depth:**
1. `.gitignore` для `.env`, `secrets/`, `*.pem`, `credentials.json`
2. Agent rules: `--exclude "**/.env,**/secrets/**"`
3. MCP exclusions: запрет доступа к `~/.ssh`, `~/.aws`, `~/.config`
4. Server restrictions: read-only режимы где возможно
5. Sandboxing: агенты в Docker с минимальными правами
6. Network: блокировка исходящих подключений
7. Whitelist: разрешённые команды вместо списка запрещённых
8. Logging: trace-файлы всех действий агента

**Никогда не отправляй в ИИ:**

| Данные | Риск |
|--------|------|
| API-ключи, токены, пароли, `.env` | Утечка credentials, доступ к инфраструктуре |
| PII (email, телефоны, адреса) | GDPR: штраф до 20M EUR |
| Медицинские данные | HIPAA: штраф до $1.5M/год |
| NDA-документы, конфиденциальный код | Юридическая ответственность, нарушение NDA |
| Session tokens, JWT, cookies | Захват сессий |
| Внутренние credentials клиентов | Репутационный и юридический ущерб |

Правило: утечка ведёт к компрометации, искам или нарушению контракта — не для ИИ.

**DO:**
- Pre-commit hooks: поиск секретов, `npm audit` / `pip-audit`
- Sanitize данные: заглушки (`REDACTED`, `example@test.com`) вместо реальных
- Проверяй, что агент не включил чувствительные данные в коммит или лог
- Соблюдай политику ИБ компании

**DON'T:**
- Захардкоженные секреты в промпте и коде: `API_KEY = "sk-ant-..."`
- SQL без параметризации: `f"SELECT * FROM users WHERE id={user_id}"`
- Копировать production логи с PII в промпт
- Давать агенту доступ к production secrets через env
- Реальные данные клиентов в тестовых примерах для ИИ
- "Локальная модель" != "безопасно" — утечки через логи и кэш

---
##9. Контроль качества и тестирование

**Код от ИИ = твой код. Ты несёшь ответственность.**

**Тестирование:**
- Пирамида: Unit 70-80%, Integration 15-20%, E2E 5-10%
- Coverage > 80% для нового кода
- Каждый endpoint — минимум 1 интеграционный тест
- Бизнес-логика — минимум 3 сценария (happy path + edge cases)
- Явно указывай сценарии в промпте — иначе только happy-path

**DO:**
- Читай каждую строку перед коммитом
- Запускай линтер, type checker, тесты после каждого изменения агента
- Проверяй edge cases и регрессии

**DON'T:**
- Мержить без ревью "потому что тесты зелёные"
- Доверять агенту на слово — модели галлюцинируют
- Игнорировать sycophancy — модель соглашается, даже если ты неправ
- Коммитить код, который ты не понимаешь
- Агент "исправляет" тест вместо кода — фиксить код, не тест
- Пропускать failing тесты
- Удалять существующие тесты без обсуждения

---
##10. Ответственность и атрибуция

**Ответственность растёт с уровнем автономии:**

| Уровень | Ты отвечаешь за |
|---------|-----------------|
| L3: Агент | Код, diff review, тесты, секреты |
| L4: Агент + MCP | Серверы, данные, API |
| L5: Оркестрация | Координация, согласованность, артефакты |

Стратегия — человеку, тактика — агенту.

**DO:**
- `Co-Authored-By: Claude <noreply@anthropic.com>` в коммитах
- Маркируй PR от агентов
- Логируй: агент, модель, задача
- ADR в конституции

**DON'T:**
- Выдавать код агента за полностью свой
- Скрывать использование ИИ от команды
- Делегировать агенту: deploy, security решения, архитектурный выбор, работу с PII

---
##11. Инцидент-респонс

Если обнаружил security-проблему в коде агента:

1. Остановить деплой, если код уже в production
2. Исправить уязвимость
3. Ротировать credentials, если скомпрометированы
4. Проверить git-историю — удалить credentials из истории (`git filter-branch` / BFG)
5. Обновить AGENTS.md — правило для предотвращения повтора
