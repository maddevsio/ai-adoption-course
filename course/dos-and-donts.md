[← Оглавление](../README.md)

# DOs and DON'Ts

Чек-лист правил работы с ИИ-инструментами. Собрано из всех модулей курса.

---

## 1. Промптинг

**DO:**
- Структурируй: роль -> контекст -> задача -> критерии приёмки
- Указывай контекст: стек, версии, файлы, паттерны проекта, ограничения
- Показывай ГДЕ смотреть и ЧТО искать, а не КАК делать
- Используй few-shot примеры (2-4) для специфичных паттернов, которые сложно описать словами
- Разбивай сложное на цепочку (prompt chaining): анализ -> план -> реализация -> тесты
- Одна задача = один промпт = один чёткий результат
- Self-consistency: проверяй результат другим агентом или другой моделью — разные модели ловят разные ошибки
- Constraint prompting: явно укажи ограничения формата и стиля кода

**DON'T:**
- Нечёткие формулировки ("сделай красивее", "оптимизируй") — модель выберет случайное направление
- God-prompt — всё в одном запросе (микросервис + БД + тесты + Docker + мониторинг)
- Промпт без контекста: язык, фреймворк, существующий код, паттерны
- Смешанная ответственность ("добавь endpoint и заодно отрефактори модуль")
- Надеяться, что смена модели компенсирует плохой промпт — Opus с плохим промптом = плохой результат

---

## 2. Инструменты

**DO:**
- Комбинируй модели по ролям: Opus для архитектуры, Sonnet для реализации, DeepSeek/Haiku для рутины — экономия 50-80%
- Задача определяет инструмент: чат для обучения, copilot для автокомплита, CLI-агент для фич
- Бесплатные инструменты покрывают 90% задач: OpenCode + DeepSeek API + Ollama ($5-10/мес)
- Ollama для приватных/NDA задач — данные не покидают машину
- Держи резервного провайдера

**DON'T:**
- Opus/GPT-5 для boilerplate — Ferrari для поездки в магазин
- Один инструмент и один провайдер на всё
- Игнорировать рост расходов — мониторь стоимость токенов
- Дорогая модель для массовых задач — DeepSeek в 10-30 раз дешевле для шаблонного кода

---

## 3. Работа с агентами

**DO:**
- Разделяй Plan и Act — проверяй план до начала реализации
- TDD: сначала тесты, потом реализация, агент итерирует до зелёных
- Ralph Loop: Do -> Check (тесты/линтер/билд) -> Fix -> повторять до зелёных тестов
- Настрой AGENTS.md с 7 секциями: Project, Stack, Structure, Conventions, Rules, Forbidden, Before Starting Work
- Обновляй AGENTS.md после каждого нового типа ошибки агента
- Правило 3 итераций: если проблема не решена за 3 попытки — меняй подход
- Steering для сложных задач: research -> plan -> implement -> verify

**DON'T:**
- Доверять архитектурные решения без твоего согласия
- Крупная задача целиком — декомпозируй на атомарные подзадачи
- Пропускать code review "потому что тесты прошли"
- Писать в AGENTS.md то, что проверяется линтером — только то, что нельзя проверить автоматически

---

## 4. Режимы: HITL vs Agentic

**DO:**

| Agentic (безопасно) | HITL (обязательно) |
|---------------------|--------------------|
| Unit-тесты | `git push` в main |
| Рефакторинг метода | Удаление файлов |
| CRUD endpoint | Изменение production БД |
| Генерация документации | Деплой в production |
| Рутинные задачи по шаблону | Бизнес-критичный код (платежи, PII) |

Правило: можно откатить `git reset` → Agentic. Нужна помощь других для отката → HITL.

Начинай с agentic, переключайся на HITL при необходимости.

**DON'T:**
- YOLO в production — только в тестовых проектах и Docker-контейнерах
- Отключать подтверждения на деструктивные операции
- YOLO при работе с приватными данными или денежными операциями

---

## 5. Управление контекстом

**DO:**
- Пиши спецификацию перед реализацией — 15 мин спеки экономят часы переделок
- Иерархия артефактов: Constitution (~400 строк) -> Plans (номерованные) -> Traces -> Fails (постмортемы)
- Traces заполняются инкрементально — сразу после каждого решения, не в конце сессии
- "MANDATORY" для обязательных действий — "Optional" для агента = "не сделает"
- Machine-checkable checkpoints: "Create -> ID, Get -> object, Delete -> 404" вместо "smoke test passes"
- Reflect-mode: отдельный агент для консолидации traces в конституцию
- После 5-10 traces — консолидируй: что повторяется? Что добавить в AGENTS.md?
- Версионируй всё в git, изменения конституции через PR с ревью

**DON'T:**
- "Сделай как-нибудь" без спецификации
- 4000 строк воды вместо 400 строк полезного контекста
- Забывать trace-файлы — без них знания теряются между сессиями
- Агенты не пишут в конституцию напрямую — только предлагают через секцию "For Constitution" в trace
- Устаревшая документация хуже отсутствия — обновляй артефакты
- AGENTS.md не дублирует линтер — только то, что нельзя проверить автоматически

---

## 6. MCP

**DO:**
- Принцип наименьших привилегий: Git read-only, БД SELECT only
- Токены в переменных окружения: `"TOKEN": "${TOKEN}"` — никогда не хардкодить в конфигах
- Whitelist вместо blacklist: "разрешено только git, npm, pytest" вместо "запрещено rm"
- Ограничивай сетевой доступ MCP-серверов — блокируй исходящие подключения без явной необходимости
- Node.js >= 18 для MCP-серверов

**DON'T:**
- MCP к production БД без read-only ограничений
- 10+ серверов одновременно — контекст перегружается
- DELETE/UPDATE права без явной необходимости
- Хардкод токенов в `mcp.json` — утечка при попадании в Git

---

## 7. Параллельные агенты и оркестрация

**DO:**
- git worktree для каждого параллельного агента — предотвращает 90% конфликтов
- Один branch = один plan = один worktree
- Разные модели для разных ролей: Opus для архитектуры, Sonnet для планирования, Haiku для кодинга
- Playbook = executable document: каждый пункт — действие с критерием завершения
- Конфликты: arbiter-agent для простых (независимые функции), manual review для сложных (одна функция изменена двумя агентами)
- Мониторинг: время на задачу, количество итераций, стоимость токенов, процент успешного завершения

**DON'T:**
- Параллельные агенты без изоляции — гарантированные конфликты
- Оркестрация на legacy-коде без тестов и документации
- Оркестрация без CI — хаос на масштабе
- Игнорировать merge-конфликты

---

## 8. Безопасность

**Defence in depth (каждый слой дополняет предыдущий):**
1. `.gitignore` для `.env`, `secrets/`, `*.pem`, `credentials.json`
2. Agent rules: `--exclude "**/.env,**/secrets/**"` в конфигурации агента
3. MCP exclusions: запрет доступа к `~/.ssh`, `~/.aws`, `~/.config`
4. Server restrictions: read-only режимы где возможно
5. Sandboxing: агенты в Docker-контейнерах с минимальными правами
6. Network: блокировка исходящих подключений без явной необходимости
7. Whitelist: явно разрешённые команды вместо списка запрещённых
8. Logging: trace-файлы с записью всех действий агента

**DO:**
- Pre-commit hooks: поиск секретов, `npm audit` / `pip-audit`
- Whitelist подход: "разрешено только X, Y, Z" вместо "запрещено A, B, C"
- Read-only режимы для review/audit задач

**DON'T:**
- Захардкоженные секреты в промпте и коде: `API_KEY = "sk-ant-..."`
- SQL без параметризации: `f"SELECT * FROM users WHERE id={user_id}"`
- YOLO-режим без sandbox — только в Docker-контейнерах с изоляцией

---

## 9. Конфиденциальность

**Никогда не отправляй в ИИ:**

| Данные | Риск |
|--------|------|
| API-ключи, токены, пароли | Утечка credentials |
| `.env` файлы | Доступ к инфраструктуре |
| PII (email, телефоны, адреса) | GDPR: штраф до 20M EUR |
| Медицинские данные | HIPAA: штраф до $1.5M/год |
| NDA-документы | Юридическая ответственность |
| Session tokens, JWT, cookies | Захват сессий |
| Внутренние credentials клиентов | Репутационный и юридический ущерб |
| Конфиденциальный код проекта | Нарушение NDA с клиентом |

Правило: если утечка данных ведёт к компрометации системы, судебным искам или нарушению контракта — эти данные не для ИИ.

**DO:**
- Sanitize данные перед отправкой агенту — убирай реальные имена, email, ключи
- Используй заглушки (`REDACTED`, `example@test.com`) в промптах с примерами данных
- Проверяй, что агент не включил чувствительные данные в коммит или лог
- Соблюдай политику информационной безопасности компании при работе с любым ИИ
- Ollama для приватных задач — данные не покидают машину

**DON'T:**
- Копировать production логи с PII в промпт
- Давать агенту доступ к production secrets через env
- Использовать реальные данные клиентов в тестовых примерах для ИИ
- Предполагать, что "локальная модель" = "безопасно" — утечки возможны через логи и кэш

---

## 10. Контроль качества и тестирование

**Код от ИИ = твой код. Ты несёшь ответственность.**

**Тестирование:**
- Пирамида: Unit 70-80%, Integration 15-20%, E2E 5-10%
- Coverage > 80% для нового кода
- Каждый endpoint — минимум 1 интеграционный тест
- Каждая функция с бизнес-логикой — минимум 3 сценария (happy path + edge cases)
- Явно указывай сценарии в промпте — без этого агент напишет 1-2 happy-path теста

**DO:**
- Читай каждую строку перед коммитом — понимай, что коммитишь
- Запускай линтер, type checker, тесты после каждого изменения агента
- Проверяй edge cases — агент оптимизирует happy path, пропускает edge cases
- Проверяй, что агент не сломал существующий код (регрессия)
- Self-consistency: используй отдельного агента-ревьюера (другая модель)
- Правило 3 итераций: если за 3 попытки не решено — меняй подход

**DON'T:**
- Мержить без ревью "потому что тесты зелёные"
- Доверять агенту на слово — модели галлюцинируют
- Игнорировать sycophancy — модель соглашается с тобой, даже если ты неправ
- Коммитить код, который ты не понимаешь
- Агент "исправляет" тест вместо кода — если тест правильный, фиксить код
- Пропускать failing тесты ("добавлю потом")
- Удалять существующие тесты без обсуждения

---

## 11. Ответственность и атрибуция

**Ответственность растёт с уровнем автономии:**

| Уровень | Ты отвечаешь за |
|---------|-----------------|
| L3: Агент | Код, который коммитишь. Diff review, тесты, секреты |
| L4: Агент + MCP | Настройки: какие серверы подключены, какие данные доступны, какие API |
| L5: Оркестрация | Результат всей системы: координация, согласованность, артефакты |

Стратегия — человеку, тактика — агенту.

**DO:**
- `Co-Authored-By: Claude <noreply@anthropic.com>` в коммитах
- Маркируй PR от агентов
- Логируй: какой агент, какая модель, какая задача
- ADR (Architecture Decision Records) в конституции — решения, которые агент не меняет без одобрения

**DON'T:**
- Выдавать код агента за полностью свой
- Скрывать использование ИИ от команды
- Делегировать агенту: production deploy, security решения, архитектурный выбор, работу с PII, бизнес-приоритеты

---

## 12. Инцидент-респонс

Если обнаружил security-проблему в коде агента:

1. Остановить деплой, если код уже в production
2. Исправить уязвимость
3. Ротировать credentials, если скомпрометированы
4. Проверить git-историю — если credentials были закоммичены, удалить из истории (`git filter-branch` / BFG Repo-Cleaner)
5. Обновить AGENTS.md — добавить правило для предотвращения аналогичных проблем
