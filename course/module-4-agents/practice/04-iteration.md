# Итерация — исправь найденные проблемы

### Цель

Научиться давать агенту конкретную обратную связь для исправления проблем, найденных на ревью.

### Сценарий

На Шаге 3 вы провели ревью и нашли проблемы (например: нет тестов для 404, линтер ругается, отсутствуют type hints). Теперь нужно поставить агенту задачу исправить их.

### Как НЕ надо ставить задачу

**Плохой промпт:**

```
Исправь всё что не так
```

**Почему плохо:**
- Агент не знает, что именно не так
- Может исправить не те проблемы
- Или вообще ничего не сделать

### Как надо ставить задачу

**Хороший промпт (на основе конкретных проблем из ревью):**

```
Я провёл ревью. Найдены следующие проблемы:

1. Отсутствуют тесты для edge cases:
   - Нет теста для PUT /tasks/999 (несуществующий ID) → ожидается 404
   - Нет теста для валидации: пустой title → ожидается 400

2. Линтер ругается:
   - main.py:45 — отсутствует type hint для параметра title
   - main.py:52 — unused import: from typing import List

3. Нарушение AGENTS.md:
   - Функция update_task использует sync код вместо async
   - Отсутствует docstring для функции update_task

Задача:
1. Добавь тесты для edge cases (пункт 1)
2. Исправь ошибки линтера (пункт 2)
3. Приведи код в соответствие с AGENTS.md (пункт 3)

После исправлений:
- Запусти pytest (все тесты должны проходить)
- Запусти ruff check . (0 ошибок)
- Покажи diff изменений для проверки
```

### Типичные проблемы и промпты для исправления

#### Проблема 1: Агент не написал тесты для edge cases

```
Добавь тесты в tests/test_tasks.py для следующих сценариев:

1. test_update_task_not_found:
   - Попытка обновить задачу с ID=999 (не существует)
   - Ожидается: HTTP 404
   - Assert: response.status_code == 404

2. test_update_task_empty_title:
   - Попытка обновить задачу с пустым title: {"title": ""}
   - Ожидается: HTTP 400 (если есть валидация) или 200 (если валидации нет)
   - Assert: проверь что title не изменился в БД

После добавления — запусти pytest и убедись что все тесты проходят.
```

#### Проблема 2: Линтер ругается на отсутствие type hints

```
Линтер выдаёт ошибки:

main.py:45 — Missing type hint for parameter 'title'
main.py:52 — Unused import: from typing import List

Исправь:
1. Добавь type hints для всех параметров функции update_task
2. Удали unused import

Запусти ruff check . после исправлений.
```

#### Проблема 3: Агент использовал sync вместо async

```
В AGENTS.md указано: "Все endpoint handlers должны использовать async/await".

Проблема: функция update_task определена как sync:
def update_task(task_id: int, title: str):
    ...

Исправь:
1. Переделай update_task в async:
   async def update_task(task_id: int, title: str):
2. Обнови все вызовы: вместо update_task() используй await update_task()
3. Убедись что БД-операции также async (через await session.execute())

Запусти тесты после изменений — убедись что всё работает.
```

#### Проблема 4: Агент сломал существующие тесты

```
После твоих изменений падают старые тесты:

FAILED tests/test_tasks.py::test_get_tasks - AssertionError

Проблема: ты изменил структуру Task model (добавил поле 'updated_at'),
но не обновил фикстуры в tests/conftest.py.

Исправь:
1. Обнови фикстуру create_task() в tests/conftest.py — добавь поле updated_at
2. Запусти pytest — убедись что все тесты проходят (старые и новые)
```

#### Проблема 5: Лишние файлы в git

```
git status показывает:
- tasks.db (файл БД)
- __pycache__/

Эти файлы не должны попадать в git (см. AGENTS.md → Forbidden).

Исправь:
1. Убери tasks.db и __pycache__/ из staged:
   git reset HEAD tasks.db __pycache__/

2. Добавь в .gitignore:
   *.db
   __pycache__/

3. Проверь: git status не должен показывать эти файлы
```

### Повторное ревью

После того как агент исправил проблемы:

1. Запустите тесты:

```bash
pytest  # или npm test
```

2. Запустите линтер:

```bash
ruff check .  # или npm run lint
```

3. Проверьте diff:

```bash
git diff
```

4. Если всё ОК — можно коммитить:

```bash
git add .
git commit -m "feat: add PUT /tasks/{id} endpoint for updating tasks"
```

### Когда остановиться

**Правило 3 итераций:** Если после 3 попыток проблема не решена — смените подход.

Агенты не всегда могут решить задачу с первого раза. Важно знать, когда остановиться:

**Стратегия:**
1. **Итерация 1:** Дайте агенту задачу, получите результат
2. **Итерация 2:** Если есть проблемы, дайте конкретную обратную связь
3. **Итерация 3:** Последняя попытка с ещё более детальными инструкциями

**Если после 3 итераций проблема не решена:**
- ❌ НЕ продолжайте бесконечно — агент может застрять в цикле
- ✅ Исправьте проблему вручную ИЛИ
- ✅ Разбейте задачу на более мелкие подзадачи ИЛИ
- ✅ Упростите требования

**Пример зацикливания:**
- Итерация 1: Агент добавил тесты, но они падают
- Итерация 2: Агент исправил тесты, но сломал линтер
- Итерация 3: Агент исправил линтер, но тесты снова падают

→ **Остановитесь.** Исправьте проблему вручную или разбейте на части (например: сначала только тесты, потом только линтер).

### Задание

1. Возьмите список проблем, найденных на Шаге 3 (ревью)
2. Для каждой проблемы — напишите конкретный промпт с описанием проблемы и критериями исправления
3. Дайте агенту задачу исправить проблемы
4. После исправлений — проведите повторное ревью (запустите тесты, линтер, проверьте diff)
5. Если всё ОК — закоммитьте изменения

### Проверка

Итерация завершена успешно, если:

- ✅ Все тесты проходят (pytest или npm test — зелёные)
- ✅ Линтер чистый (0 ошибок)
- ✅ Код соответствует AGENTS.md (type hints, async, conventions)
- ✅ Нет лишних файлов в git status
- ✅ Изменения закоммичены

### Время выполнения

10 минут
