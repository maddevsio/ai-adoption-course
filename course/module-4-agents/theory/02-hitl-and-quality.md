[← Оглавление](../../../README.md)

## 5. Human-in-the-loop vs Agentic mass generation

Два режима работы с агентом:

**Human-in-the-loop (HITL)**: агент предлагает действие → вы подтверждаете → агент выполняет → предлагает следующее. 

Когда использовать human-in-the-loop:
- **Критичный для бизнеса код**: логика платежей, обработка персональных данных, алгоритмы безопасности.
- **Unfamiliar territory**: задача в области, которую вы плохо знаете (например, первый раз настраиваете Kubernetes).
- **Security-sensitive**
- **Production code без хороших тестов**: если нет "подушки безопасности" в виде тестов, нужно лучше контролировать агента.

**Agentic mass generation**: агент получает задачу, работает автономно, и возвращает результат. Вы проверяете результат post-factum.

Когда использовать agentic:
- **Хорошо описанные и декомпозированные задачи**
- **Рутинные задачи с известным паттерном**: добавление CRUD для новой сущности по аналогии с существующими.
- **Тесты**: написание unit-тестов для уже существующей функции.

HITL медленный -- каждое подтверждение разбивает поток. Agentic даёт некачественный код при слабых критериях приёмки.

Модель **Enji Fleet**: **начинать с human-in-the-loop, постепенно переходить к agentic**. Переход происходит по мере настройки правил (AGENTS.md), накопления тестов и роста доверия к агенту.

### Алгоритм выбора режима работы

> [Диаграмма: Выбор режима работы](../diagrams/mode-selection.md)

**Общее правило:**
- **Agentic:** Если можно откатить `git reset --hard` или `Ctrl+Z`
- **Human-in-the-loop:** Если откат требует помощи других людей или невозможен

**В проекте Enji Fleet**:
- Agentic: добавление новых skills, рефакторинг конституции, обновление документации
- HITL: изменение core архитектуры, обновление dependencies, изменение AGENTS.md

Пример промпта на выполнение плана из **Enji Fleet**:

> **Действуй автономно.** Не спрашивай разрешения на создание файлов, установку инструментов (go get, npm install), запуск тестов, исправление ошибок в коде. Ты можешь принимать решения в рамках задачи.
>
> **Спрашивай ТОЛЬКО если:**
> - Требования противоречивы и ты не можешь разрешить это сам
> - Невозможно продолжить из-за отсутствующей информации (например, API key для внешнего сервиса)
> - Критическая ошибка, которую ты не можешь исправить после 3 попыток
>
> **СТОП и исправь (блокирующие условия):**
> - Тест падает → исправь код, пока тест не пройдёт
> - go vet выдаёт ошибки → исправь все
> - Coverage упал ниже минимума → добавь тесты
> - Build падает → исправь, пока не соберётся

## 6. Повышение качества через инструменты самопроверки

LLM может пропустить баги, дыры в безопасности, нарушения конвенций.

Решение: детерминистические инструменты в workflow агента.
- **Линтеры** -- статический анализ кода
- **Type checkers** -- проверка типов
- **Тесты** -- автоматическая проверка поведения
- **Security scanner** -- поиск уязвимостей

Интеграция в рабочий процесс:
1. **Pre-commit hooks** -- автоматический запуск проверок перед коммитом
2. **Инструкции в AGENTS.md** -- явные правила для агента
3. **TDD-подход** -- агент не может сказать "готово", если pytest выдаёт ошибки

**Enji Fleet**: перед тем как человек посмотрит на код, он должен пройти все автоматические проверки (go vet, go test, gofmt, golangci-lint). Агент не может создать PR с failing tests или ошибками линтера.

## 7. Переключение между режимами

**Начинайте agentic, переходите на HITL при необходимости:**

**Признаки что нужен HITL:**
- AI спрашивает "продолжить?" несколько раз подряд
- Задача касается production environment
- Вы не до конца понимаете что AI собирается делать
- Изменения влияют на других разработчиков
---

[← Модуль 4: Работа с AI-агентом](01-agent-fundamentals.md) | [Оглавление](../../../README.md) | [Тестирование в AI-assisted разработке →](03-testing-with-agents.md)
