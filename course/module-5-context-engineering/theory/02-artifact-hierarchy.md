[← Оглавление](../../../README.md)

## 3. Артефакты SDD

> [Диаграмма: Иерархия артефактов (Constitution -> Spec -> Trace)](../diagrams/artifact-hierarchy.md)

Артефакты образуют иерархию:

```
Constitution (правила, ADR, паттерны)
    ↑ консолидация (reflect-mode)
Plans (что делать: задачи, порядок, критерии)
    ↓ выполнение (dev-mode)
Traces (что сделано: решения, проблемы, находки)
    ↓ анализ инцидентов
Fails (что пошло не так: root cause, prevention)
```

| Артефакт | Назначение | Когда создаётся            | Кто читает |
|----------|-----------|----------------------------|------------|
| Constitution | Правила и стандарты проекта | Обновляется в reflect-mode | Все агенты перед работой |
| Plan | Задачи конкретной итерации | Перед началом работы       | Агент-исполнитель |
| Trace | Лог выполнения плана | Во время и после работы    | Reflect-mode агент |
| Fail | Постмортем инцидента | После обнаружения проблемы | Все агенты |

### 3.1. Constitution (Конституция проекта)

**Что это:** живой документ ~400-500 строк, обязательный к прочтению перед любой работой. Содержит tech stack, архитектурные решения (ADR), обязательные паттерны и запреты (antipatterns).

**Где хранить:** `constitution.md` в директории документации.

Конституция — не AGENTS.md. AGENTS.md — краткая справка (tech stack, команды). Конституция — полный документ с ADR и паттернами (~400-500 строк).

**Правило защиты Constitution:**

> Агенты **НЕ пишут** в constitution напрямую. Предложения идут в секцию "Для конституции" в trace. Consolidation — в reflect-mode.

### 3.2. Feature Specification (Спецификация задачи)

**Что это:** детальное описание конкретной задачи с acceptance criteria, ограничениями, примерами.

**Где хранить:** `plans/` или `specs/` директория. Нумерованные планы типа `003-auth-system.plan.md`, выполняемые строго по порядку.

```markdown
# Plan 003: Authentication System

## Цель
Реализовать JWT-аутентификацию для API.

## Acceptance Criteria
- [ ] POST /api/auth/login возвращает JWT токен
- [ ] Middleware проверяет токен на protected routes
- [ ] Токен истекает через 24h
- [ ] Rate limiting 5 попыток / 15 минут

## Ограничения
- Использовать bcrypt для паролей
- JWT с HS256, секрет из ENV
- Следовать constitution: Repository pattern
```

### 3.3. Trace (История реализации)

**Что это:** документ, который агент создаёт после выполнения плана. Фиксирует принятые решения, отклонения от плана, проблемы и их решения.

**Где хранить:** `traces/` директория. Файлы типа `003-auth-system.trace.md`.

```markdown
# Trace: Authentication System

## Что сделано
Реализованы endpoints /login, /refresh, middleware для JWT.

## Для конституции
- Добавить: все auth endpoints требуют rate limiting
- Паттерн: JWT claims должны включать `user_id` и `role`

## Технические решения
- Выбрали HS256 вместо RS256: проще для старта, достаточно для MVP
- Храним refresh token в БД: нужна возможность revoke

## Проблемы и решения
- **Проблема:** тесты падали из-за race condition в token validation
- **Решение:** добавили mutex в token cache
```

### 3.4. Цикл накопления знаний

Артефакты образуют замкнутый цикл:

```
Agent работает → пишет trace → консолидация знаний →
обновляет constitution → следующий agent читает constitution
```

**Reflect-mode** — специальный режим работы агента-ревьюера:
- НЕ пишет код (нет доступа к инструментам разработки)
- Читает traces от других агентов
- Консолидирует знания в constitution
- Проверяет соответствие кода паттернам из constitution
- Выявляет повторяющиеся проблемы и добавляет их в antipatterns

Разделение ролей защищает constitution: dev-mode создаёт traces с предложениями, reflect-mode решает что попадёт в constitution.
---

[← Модуль 5: Управление контекстом (Context Engineering)](01-context-and-sdd.md) | [Оглавление](../../../README.md) | [4. Plans: пронумерованные и самодостаточные →](03-plans-traces-fails.md)
