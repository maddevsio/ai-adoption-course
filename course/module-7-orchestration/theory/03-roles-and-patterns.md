## 5. Ролевая модель агентов

Не стоит использовать один универсальный агент на все задачи. Специализированные роли работают эффективнее.

> [Диаграмма: Ролевая модель агентов (Architect -> Planner -> Developer -> QA)](../diagrams/role-model.md)

**Четыре ключевые роли:**

| Роль | Модель | Задачи | Когда использовать |
|------|--------|--------|--------------------|
| **Архитектор** | Дорогая (Opus 4.6, GPT-5) | Проектирование системы, ADR, выбор паттернов | Начало проекта, новая крупная фича |
| **Планировщик** | Средняя (Sonnet 4.5) | Декомпозиция задач, определение порядка, критерии приёмки | После проектирования, перед разработкой |
| **Разработчик** | Дешёвая (Haiku, Codex Mini, Gemini Flash) | Написание кода по спецификации, тесты, self-check | Основная масса работы |
| **QA / Ревьюер** | Средняя (Sonnet) | Интеграционное тестирование, проверка edge cases, баг-репорт | После разработки, перед merge |

**Принцип: разные модели для разных ролей.** 
- Не тратить Opus ($15/1M input) на boilerplate код. 
- Не ставить Haiku ($0.80/1M input) на архитектурное проектирование.

**Agents-hot-swap** — если агент зациклился или упёрся в rate limit, оркестратор заменяет его другим агентом с той же ролью. Задачи атомарные, поэтому замена безболезненна: новый агент читает задачу, контекст проекта и продолжает работу.

## 6. Паттерны оркестрации

### 6.1. Генератор + Ревьюер

Один агент пишет код, другой проверяет.

1. Генератор получает задачу и пишет код
2. Ревьюер проверяет по критериям: тесты написаны? нет уязвимостей? соответствует code style?
3. Если проблемы — отправляет обратно генератору с замечаниями
4. Цикл повторяется до одобрения

**Плюс:** разделение ответственности, выше шанс отловить несоответствия спецификации.
**Минус:** дороже по токенам. Избыточен для простых задач.

### 6.2. Декомпозиция

Разбить фичу на независимые подзадачи и раздать разным агентам одновременно.

**Пример:** фича "регистрация пользователя":
- Агент 1: API endpoint `POST /api/auth/register` (30 мин)
- Агент 2: UI форма регистрации на React (30 мин)
- Агент 3: E2E тесты (30 мин)

Вместо 90 минут последовательно — 30-40 минут параллельно.

**Когда:** фича делится на независимые части (backend, frontend, tests).
**Минус:** нужна координация при слиянии, возможны конфликты в shared файлах.

### 6.3. Иерархия (Research → Plan → Implement → Review)

Координатор управляет цепочкой:

1. **Research** — агент изучает требования, анализирует код, определяет границы
2. **Plan** — планировщик создаёт список атомарных задач с зависимостями
3. **Implement** — разработчики берут задачи и реализуют в отдельных worktrees
4. **Review** — QA проверяет результат, если не принял — задача возвращается в Implement

**Когда:** крупные фичи с неочевидными требованиями, незнакомый домен.
**Минус:** overhead на координацию, избыточен для "добавить кнопку на форму".
