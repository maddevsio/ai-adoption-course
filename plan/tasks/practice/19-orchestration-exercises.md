# Задача 19: Упражнения по оркестрации

## Цель

5 практических шагов для Модуля 7. Ученик проходит путь от git worktrees до параллельной работы нескольких агентов.

## Что сделать

### Шаг 1: Git worktree (10 мин)

- Создать worktree для тестового проекта
- Команды: `git worktree add`, `git worktree list`, `git worktree remove`
- Проверить: два рабочих каталога, каждый на своей ветке
- Запустить агента в worktree (не в основной директории)

### Шаг 2: Генератор + Ревьюер (15 мин)

Паттерн: один агент пишет код, другой проверяет.
- Подготовленная задача: "Добавить DELETE /tasks/{id} endpoint"
- Агент 1 (в сессии/терминале 1): реализует
- Агент 2 (в сессии/терминале 2): получает промпт "Проведи code review кода в [path], проверь: тесты, стиль, безопасность"
- Ученик передаёт результат ревью обратно генератору
- Рефлексия: нашёл ли ревьюер то, что ты бы нашёл?

### Шаг 3: Параллельная работа (15 мин)

2 агента делают разные подзадачи одновременно:
- Агент A (worktree A): добавляет endpoint для пользователей (users)
- Агент B (worktree B): добавляет middleware для логирования
- Оба работают параллельно
- Ученик мониторит обе сессии

### Шаг 4: Слияние результатов (10 мин)

- Слить ветки из worktree A и B
- Разрешить конфликты (если есть)
- Запустить тесты на объединённом результате
- Рефлексия: что пошло гладко, что нет

### Шаг 5: Runbook для своего проекта (10 мин)

- Ученик выбирает задачу из своего проекта
- Пишет runbook: декомпозиция на подзадачи, кому какая, порядок, критерии
- Шаблон runbook:
  ```
  # Runbook: [название задачи]
  ## Подзадачи
  1. [задача] → Агент A (worktree: feature-x)
  2. [задача] → Агент B (worktree: feature-y)
  ## Порядок
  - Шаги 1 и 2 параллельно
  - Слияние после обоих
  ## Критерии приёмки
  - ...
  ```

### Бонус: Расширенные возможности (опционально, 15 мин)

Обзорная секция — ученик читает и пробует одно на выбор:

1. **Claude Code headless**: запустить `claude -p "Опиши архитектуру проекта" --output-format json` и разобрать вывод. Показать как это можно использовать в скриптах и CI.

2. **Auth-токены для автоматизации**:
   - `ANTHROPIC_API_KEY` — для API-биллинга
   - `claude setup-token` — генерация 1-годового OAuth-токена (для подписчиков Max)
   - Где хранить: секреты CI, `.env` для локальной автоматизации
   - Пример: GitHub Actions с `anthropics/claude-code-action@v1`

3. **Claude Agent SDK**:
   - Показать минимальный пример на Python или TypeScript
   - `pip install claude-agent-sdk` / `npm install @anthropic-ai/claude-agent-sdk`
   - Программный запуск агента с выбором tools и permissions
   - Когда нужен SDK, а когда хватает `claude -p`

4. **Agent Teams** (experimental):
   - `export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1`
   - Запустить team из 2 агентов на простой задаче
   - Показать shared task list и messaging

5. **OpenClaw**:
   - https://github.com/openclaw/openclaw (188K stars)
   - Что это: open-source платформа автономных агентов (не только код — Slack, Jira, email, браузер)
   - Multi-agent routing: разные модели на разные задачи
   - Интеграция с Claude Code через MCP
   - Экосистема: Claworc (управление инстансами), Antfarm (team-of-agents)
   - Установить и запустить базовый пример (если время позволяет)

## Формат результата

MD-файл `course/module-7-orchestration/practice.md`

## Критерии приёмки

- Git worktree команды с пояснениями
- Паттерн генератор+ревьюер: конкретные промпты для обоих агентов
- Параллельная задача: две независимые подзадачи для проекта ученика
- Инструкция по слиянию и разрешению конфликтов
- Шаблон runbook
- Бонусная секция: headless-режим, auth-токены, Agent SDK, Agent Teams, OpenClaw (обзор + 1 упражнение на выбор)
- Суммарно 60 мин (+ 15 мин бонус)

## Зависимости

- Задача 10 (теория оркестрации)

## Примеры из Enji Fleet для упражнений

Репозиторий: `/home/kb/Documents/workspace/mad_devs/enji-fleet`
Анализ: `sources/enji-fleet-analysis.md`

### Для Шага 1 (Git worktree)
Показать правило из Fleet (`AGENTS.md`): worktree обязателен, никогда не работать в основной директории. Паттерн именования: `../enji-fleet-<plan-name>`. Одна ветка = один план.

### Для Шага 5 (Runbook)
Использовать как образец `docs/prompts/code-implementation-prompt.md` из Fleet -- это по сути runbook на 300 строк для автономного агента-разработчика. Progress Table с emoji-статусами, блокирующие правила, инкрементальный trace.

Также показать `agent-profiles.yaml` как пример распределения ролей между агентами: developer (normal priority), architect (high priority), codex-developer (low priority).
